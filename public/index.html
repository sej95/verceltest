<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="在线免费的语音合成、文字转语音、文字合成配音服务，基于edge-tts语音合成服务提供，无需登录无需注册，在线免费合成语音"/>
  <meta name="keyword" content="语音合成,文字合成,文字配音,合成语音,edge-tts"/>
  <title>语音合成-文字转语音-srt字幕转语音-tts</title>
  <link href="/output.css" rel="stylesheet">
  <script src="/vue.js"></script>
  
  <style>
  #layui-nav {
    position: fixed;
    width: 100%;
    top: 0;
    left: 0;
    z-index: 99;
    overflow: auto;
    white-space: nowrap;
    background: #eee;
  }
  .layui-nav .layui-nav-item {
    position: relative;
    display: inline-block;
    margin-top: 0;
    list-style: none;
    vertical-align: middle;
    line-height: 60px;
  }
  .layui-nav .layui-nav-item a {
    color: #333;
  }
  .layui-nav .layui-nav-item a {
    display: block;
    padding: 0 20px;
    color: #333;
    transition: all .3s;
    -webkit-transition: all .3s;
  }
  .layui-nav .layui-nav-item a:hover, .layui-nav .layui-this a {
    color: #009688;
    text-decoration: none;
  }
    #app { margin-top: 50px }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div id="app">
    <ul id="layui-nav" class="layui-nav">
      <li class="layui-nav-item"><a href="#" @click.prevent="toggleStyleTable">iuai</a></li>
    </ul>
    <div class="container mx-auto p-4 md:p-8">
      <h1 class="text-3xl font-bold mb-2 text-center text-gray-800">文字合成语音/SRT字幕转语音</h1>

      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="mb-4">
          <label for="fileInput" class="block text-gray-700 font-medium mb-2">选择想合成语音的文件 (srt/txt):</label>
          <input type="file" id="fileInput" @change="handleFileSelect" accept=".srt,.txt" class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-4">
          <label for="textInput" class="block font-medium mb-2 ">输入文本<span class="ms-2 text-xs text-gray-700">行尾加<code>[50]</code>代表添加50毫秒静音，<code>[500]</code>代表加500毫秒静音，中括号内数字代表静音毫秒数</span></label>
          <textarea placeholder="选择txt文本或srt字幕上传，或直接在此输入要配音的文字" id="textInput" v-model="text" rows="5" class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white rounded-lg shadow-md p-6">
          <label for="language" class="block text-gray-700 font-medium mb-2">文本语言:</label>
          <select id="language" v-model="selectedLanguage" class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option v-for="(roles, language) in language_role" :value="language" :key="language">{{ names[language] }}</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6" v-if="selectedLanguage">
          <div class="flex">
            <label for="voice" class="block text-gray-700 font-medium mb-2">配音角色</label>
            (<span id="shiting" class="cursor-pointer" @click="shiting">试听</span>)
          </div>
          <select id="voice" v-model="selectedVoice" class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option v-for="voice in voices" :value="voice" :key="voice">{{ voice.split('-').slice(-1)[0] }}</option>
          </select>
        </div>  
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mt-4">
        <div class="bg-white rounded-lg shadow-md p-6">
          <label for="speed" class="block text-gray-700 font-medium mb-2">语速 (0.1 -> 5.0):</label>
          <div class="flex items-center">    
            <input type="range" id="speed" v-model.number="speed" min="0.1" max="5.0" step="0.1" class="w-full mr-2">
            <span class="text-gray-600">{{ speed }}</span>
          </div>
        </div>    
        <div class="bg-white rounded-lg shadow-md p-6">
          <label for="pitch" class="block text-gray-700 font-medium mb-2">音调 (-100 -> +100):</label>
          <div class="flex items-center">
            <input type="range" id="pitch" v-model.number="pitch" min="-100" max="100" class="w-full mr-2">
            <span class="text-gray-600">{{ pitch }}</span>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
          <label for="volume" class="block text-gray-700 font-medium mb-2">音量 (0.1 -> 5):</label>
          <div class="flex items-center">
            <input type="range" id="volume" v-model.volume="volume" min="0.1" step="0.1" max="5" class="w-full mr-2">
            <span class="text-gray-600">{{ volume }}</span>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
          <label for="style" class="block text-gray-700 font-medium mb-2">语气(部分不起作用):</label>
          <select id="style" v-model="selectedStyle" class="w-full border border-gray-300 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option v-for="st in styles" :value="st" :key="st">{{ st }}</option>
          </select>
        </div>
      </div>
      
      <div id="audioContainer" class="my-3 text-center bg-white flex justify-center py-3 "></div>
      
      <!-- 进度显示 -->
      <div v-if="isGenerating" class="text-center my-4">
        <p>合成进度: {{ progress }} / {{ totalSegments }}</p>
      </div>

      <div class="mt-8 text-center">
        <button @click="generateSpeech" :disabled="isGenerating" class="bg-red-500 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed">
          {{ isGenerating ? '语音合成中...' : '执行合成语音' }}
        </button>
      </div>

      <table v-show="showStyleTable" class="min-w-full divide-y divide-gray-200 my-4">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">语气风格</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">风格说明</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- 表格内容保持不变，略去以节省篇幅 -->
          <tr v-for="style in styles" :key="style">
            <td class="px-6 py-4 whitespace-nowrap"><code>{{ style }}</code></td>
            <td class="px-6 py-4 text-sm text-gray-500">{{ styleDescriptions[style] }}</td>
          </tr>
        </tbody>
      </table>

      <footer class="bg-gray-100 mt-6 mb-2 py-4 mt-8">
        <div class="container mx-auto text-center text-gray-500 text-sm">
          版权所有 © 2025 iuaihub.com 
        </div>
      </footer>
    </div>
  </div>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          text: '',
          styles: [
            'friendly', 'advertisement_upbeat', 'affectionate', 'angry', 'assistant', 'calm', 'chat', 'cheerful',
            'customerservice', 'depressed', 'disgruntled', 'documentary-narration', 'embarrassed', 'empathetic',
            'envious', 'excited', 'fearful', 'gentle', 'hopeful', 'lyrical', 'narration-professional', 'narration-relaxed',
            'newscast', 'newscast-casual', 'newscast-formal', 'poetry-reading', 'sad', 'serious', 'shouting',
            'sports_commentary', 'sports_commentary_excited', 'whispering', 'terrified', 'unfriendly'
          ],
          styleDescriptions: {
            'friendly': '表达一种愉快、怡人且温暖的语气。 听起来很真诚且满怀关切。',
            'advertisement_upbeat': '用兴奋和精力充沛的语气推广产品或服务。',
            // 其他风格说明略去，可从原代码复制
          },
          names: { /* 语言名称保持不变 */ },
          welcome: { /* 欢迎语保持不变 */ },
          language_role: { /* 语言角色保持不变 */ },
          selectedLanguage: 'zh',
          selectedVoice: '',
          selectedStyle: 'friendly',
          speed: 1.0,
          volume: 1.0,
          pitch: 0,
          isGenerating: false,
          apiKey: 'adgas213423235saeg',
          showStyleTable: false,
          progress: 0, // 合成进度
          totalSegments: 0 // 总段数
        };
      },
      watch: {
        selectedLanguage(newLanguage) {
          this.$nextTick(() => {
            if (this.voices.length > 0) {
              this.selectedVoice = this.voices[0];
            } else {
              this.selectedVoice = null;
              console.warn(`No voices available for language: ${newLanguage}`);
            }
          });
        }
      },
      mounted() {
        this.$nextTick(() => {
          this.selectedVoice = this.voices[0];
        });
      },
      computed: {
        voices() {
          return this.language_role[this.selectedLanguage] || [];
        }
      },
      methods: {
        handleFileSelect(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              this.text = e.target.result;
            };
            reader.readAsText(file);
          }
        },
        shiting() {
          if (!this.selectedVoice || this.selectedVoice == 'No') {
            return alert('必须选择音色');
          }
          this.generateSpeech(this.welcome[this.selectedLanguage]);
        },
        parseText() {
          let lines = this.text.trim().split('\n');
          let filteredLines = [];
          for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            const isSequenceNumber = /^\s*?\d+\s*?$/;
            const isTimecode = /^\d{1,2}:\d{1,2}:\d{1,2}(,\d{1,3})?\s*?\-\->\s*?\d{1,2}:\d{1,2}:\d{1,2}(,\d{1,3})\s*?$/;

            if (isSequenceNumber.test(line)) {
              if (i + 1 < lines.length && isTimecode.test(lines[i + 1].trim())) {
                continue;
              }
            } else if (isTimecode.test(line)) {
              continue;
            }
            if (line !== '') {
              filteredLines.push(line);
            }
          }
          return filteredLines.join('\n');
        },
        // 分段文本
        splitText(text, maxLength = 500) {
          const segments = [];
          let currentSegment = '';
          const lines = text.split('\n');

          for (let line of lines) {
            if (currentSegment.length + line.length > maxLength && currentSegment) {
              segments.push(currentSegment.trim());
              currentSegment = line;
            } else {
              currentSegment += (currentSegment ? '\n' : '') + line;
            }
          }
          if (currentSegment) {
            segments.push(currentSegment.trim());
          }
          return segments;
        },
        // 合并音频
        async mergeAudioBlobs(blobs) {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const buffers = await Promise.all(blobs.map(blob => 
            fetch(URL.createObjectURL(blob)).then(res => res.arrayBuffer()).then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
          ));

          const totalLength = buffers.reduce((sum, buffer) => sum + buffer.length, 0);
          const mergedBuffer = audioContext.createBuffer(1, totalLength, buffers[0].sampleRate);
          let offset = 0;

          for (let buffer of buffers) {
            mergedBuffer.getChannelData(0).set(buffer.getChannelData(0), offset);
            offset += buffer.length;
          }

          const blob = await this.bufferToWave(mergedBuffer, totalLength);
          return blob;
        },
        // 将AudioBuffer转换为WAV格式（简易实现）
        bufferToWave(abuffer, len) {
          return new Promise((resolve) => {
            const numOfChan = abuffer.numberOfChannels;
            const length = len * numOfChan * 2 + 44;
            const buffer = new ArrayBuffer(length);
            const view = new DataView(buffer);
            const channels = [];
            let sample, offset = 0, pos = 0;

            const setUint16 = (data) => view.setUint16(pos, data, true) & (pos += 2);
            const setUint32 = (data) => view.setUint32(pos, data, true) & (pos += 4);

            setUint32(0x46464952); // "RIFF"
            setUint32(length - 8); // file length - 8
            setUint32(0x45564157); // "WAVE"
            setUint32(0x20746d66); // "fmt " chunk
            setUint32(16); // length = 16
            setUint16(1); // PCM (uncompressed)
            setUint16(numOfChan);
            setUint32(abuffer.sampleRate);
            setUint32(abuffer.sampleRate * 2 * numOfChan); // avg. bytes/sec
            setUint16(numOfChan * 2); // block-align
            setUint16(16); // 16-bit
            setUint32(0x61746164); // "data" - chunk
            setUint32(length - pos - 4); // chunk length

            for (let i = 0; i < abuffer.numberOfChannels; i++) {
              channels.push(abuffer.getChannelData(i));
            }

            while (offset < len) {
              for (let i = 0; i < numOfChan; i++) {
                sample = Math.max(-1, Math.min(1, channels[i][offset]));
                sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                view.setInt16(pos, sample, true);
                pos += 2;
              }
              offset++;
            }

            resolve(new Blob([buffer], { type: 'audio/wav' }));
          });
        },
        async generateSpeech(listener_text) {
          const workerUrl = 'https://ttsapi.pyvideotrans.com/v1/audio/speech';
          const parsedText = typeof listener_text === 'string' ? listener_text : this.parseText();
          if (!this.selectedVoice || this.selectedVoice == 'No') {
            return alert('必须选择音色');
          }
          if (!parsedText) {
            return alert('必须上传或输入要合成的文字');
          }

          const segments = this.splitText(parsedText);
          this.totalSegments = segments.length;
          this.progress = 0;
          this.isGenerating = true;

          const requestBody = {
            "model": "tts-1",
            "voice": this.selectedVoice,
            "response_format": "mp3",
            "speed": this.speed,
            "volume": this.volume,
            "pitch": this.pitch,
            "style": this.selectedStyle
          };

          const audioBlobs = [];
          for (let segment of segments) {
            requestBody.input = segment;
            try {
              const response = await fetch(workerUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${this.apiKey}`,
                },
                body: JSON.stringify(requestBody),
              });

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
              }

              const audioBlob = await response.blob();
              audioBlobs.push(audioBlob);
              this.progress++;
            } catch (error) {
              console.error('Error generating segment:', error);
              alert(`分段合成失败: ${error.message}`);
              this.isGenerating = false;
              return;
            }
          }

          let finalAudioBlob;
          if (audioBlobs.length > 1) {
            finalAudioBlob = await this.mergeAudioBlobs(audioBlobs);
          } else {
            finalAudioBlob = audioBlobs[0];
          }

          const audioUrl = URL.createObjectURL(finalAudioBlob);
          const existingAudio = document.getElementById('audioElement');
          if (existingAudio) existingAudio.remove();
          const existingDownloadButton = document.getElementById('downloadButton');
          if (existingDownloadButton) existingDownloadButton.remove();

          const audioElement = document.createElement('audio');
          audioElement.id = 'audioElement';
          audioElement.src = audioUrl;
          audioElement.controls = true;
          audioElement.autoplay = true;

          const downloadButton = document.createElement('button');
          downloadButton.id = 'downloadButton';
          downloadButton.textContent = '下载';
          downloadButton.className = 'ml-2 font-bold py-2 px-4 rounded';
          downloadButton.addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = audioUrl;
            link.download = getmp3name();
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });

          if (typeof listener_text !== 'string') {
            const audioContainer = document.getElementById('audioContainer');
            audioContainer.appendChild(audioElement);
            audioContainer.appendChild(downloadButton);
          }

          this.isGenerating = false;
        },
        toggleStyleTable() {
          this.showStyleTable = !this.showStyleTable;
        }
      }
    }).mount('#app');
    
    function getmp3name() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day}-${hours}-${minutes}-${seconds}.mp3`;
    }
  </script><!--
  <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
  <script>LA.init({id:"KO5lYldwVUTyC8eE",ck:"KO5lYldwVUTyC8eE"})</script>-->
</body>
</html>
